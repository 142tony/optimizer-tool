<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML é›ªç¢§åœ– (Sprite) æ¥µé™å£“ç¸®å·¥å…·</title>
    <style>
        :root { --primary: #8b5cf6; --bg: #f8fafc; --text: #1e293b; }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: var(--bg); color: var(--text);
            display: flex; flex-direction: column; align-items: center;
            padding: 30px; line-height: 1.6;
        }
        .container {
            background: white; padding: 2rem; border-radius: 1rem;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
            max-width: 650px; width: 100%; text-align: center;
        }
        h1 { color: var(--primary); margin-top: 0; }
        .upload-box {
            border: 2px dashed #cbd5e1; border-radius: 12px;
            padding: 40px; margin: 20px 0; cursor: pointer; position: relative;
            background: #f1f5f9; transition: 0.2s;
        }
        .upload-box:hover { border-color: var(--primary); background: #f3e8ff; }
        .upload-box input {
            position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer;
        }
        .controls {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; text-align: left;
        }
        label { display: block; font-size: 0.9rem; margin-bottom: 5px; font-weight: bold; }
        input[type="number"] { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box;}
        
        .btn {
            background: var(--primary); color: white; border: none;
            padding: 12px 30px; border-radius: 8px; font-size: 1rem;
            cursor: pointer; display: none; margin-top: 15px;
        }
        .btn:hover { filter: brightness(1.1); }
        
        #log {
            background: #1e293b; color: #4ade80; text-align: left;
            padding: 15px; border-radius: 8px; margin-top: 20px;
            height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.85rem;
            display: none; white-space: pre-wrap;
        }
        .warning { color: #f59e0b; font-size: 0.9rem; background: #fffbeb; padding: 10px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #f59e0b; text-align: left;}
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ¨ CSS é›ªç¢§åœ–æ¥µé™å£“ç¸®</h1>
    <p>å°ˆé–€è™•ç† SingleFile å„²å­˜çš„è‰²å¡ç¶²é ï¼Œå£“ç¸® CSS ä¸­çš„èƒŒæ™¯å¤§åœ–ã€‚</p>

    <div class="warning">
        <strong>âš ï¸ æ³¨æ„ï¼š</strong> é€™æ˜¯ã€Œå¤§åœ–ã€ï¼Œè«‹ä¸è¦å°‡å¯¬åº¦è¨­å¾—å¤ªå° (å¦‚ 60px)ï¼Œå¦å‰‡æ‰€æœ‰è‰²å¡Šéƒ½æœƒç³Šæˆä¸€åœ˜ã€‚
        <br>å»ºè­°ï¼šå…ˆå˜—è©¦ <strong>å¯¬åº¦ 1024 æˆ– 2048</strong>ï¼Œä¸»è¦é ã€ŒWebP å“è³ªã€ä¾†ç˜¦èº«ã€‚
    </div>

    <div class="controls">
        <div>
            <label>æœ€å¤§å¯¬åº¦ (px)</label>
            <input type="number" id="maxWidth" value="2048" placeholder="é è¨­ä¸ç¸®æ”¾">
            <small style="color:#64748b">è‹¥åŸåœ–æ›´å°å‰‡ä¸æ”¾å¤§</small>
        </div>
        <div>
            <label>WebP å“è³ª (0.1 - 1.0)</label>
            <input type="number" id="quality" value="0.3" step="0.1" max="1" min="0.1">
        </div>
    </div>

    <div class="upload-box" id="dropZone">
        <input type="file" id="fileInput" accept=".html,.htm">
        <div id="uploadText">
            ğŸ“ æ‹–æ›³ HTML æª”æ¡ˆè‡³æ­¤<br>
            <span style="font-size:0.8rem;color:#64748b">æ”¯æ´ CSS background-image æå–</span>
        </div>
    </div>

    <div id="log"></div>
    <div id="stats" style="margin-top:15px; font-weight:bold; color:var(--primary)"></div>
    <button id="downloadBtn" class="btn">â¬‡ï¸ ä¸‹è¼‰å£“ç¸®å¾Œçš„æª”æ¡ˆ</button>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const logArea = document.getElementById('log');
    const downloadBtn = document.getElementById('downloadBtn');
    let originalFileName = '';

    fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        originalFileName = file.name.replace(/\.html?$/i, '');
        
        logArea.style.display = 'block';
        logArea.textContent = '';
        downloadBtn.style.display = 'none';
        document.getElementById('stats').textContent = '';

        log(`ğŸš€ è®€å–æª”æ¡ˆ: ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`);
        const text = await file.text();
        await processSpriteHTML(text, file.size);
    });

    function log(msg) {
        logArea.textContent += msg + '\n';
        logArea.scrollTop = logArea.scrollHeight;
    }

    async function processSpriteHTML(htmlContent, originalSize) {
        const maxWidth = parseInt(document.getElementById('maxWidth').value) || 2048;
        const quality = parseFloat(document.getElementById('quality').value) || 0.3;

        // 1. æ­£å‰‡è¡¨é”å¼æŠ“å–æ‰€æœ‰ Base64 åœ–ç‰‡ (æ”¯æ´ CSS url() å’Œ img src)
        // æ•æ‰æ ¼å¼: url("data:image/...") æˆ– src="data:image/..."
        const regex = /(url\(['"]?|src=["'])(data:image\/[^;]+;base64,[^"'\)]+)(['"]?\)|["'])/g;
        
        // æ‰¾å‡ºæ‰€æœ‰ä¸é‡è¤‡çš„åœ–ç‰‡ (é€šå¸¸é›ªç¢§åœ–åªæœ‰ä¸€å¼µå¾ˆå¤§çš„)
        const matches = [...htmlContent.matchAll(regex)];
        const uniqueImages = new Map(); // key: oldBase64, value: newBase64

        log(`ğŸ” æƒæä»£ç¢¼... å…±ç™¼ç¾ ${matches.length} è™•åœ–ç‰‡å¼•ç”¨`);

        for (const match of matches) {
            const fullBase64 = match[2];
            if (!uniqueImages.has(fullBase64)) {
                uniqueImages.set(fullBase64, null); // æ¨™è¨˜ç‚ºå¾…è™•ç†
            }
        }

        const totalUnique = uniqueImages.size;
        log(`ğŸ“¦ å¯¦éš›ç¨ç«‹åœ–ç‰‡æ•¸é‡: ${totalUnique} å¼µ (å…¶é¤˜ç‚ºé‡è¤‡å¼•ç”¨)`);
        
        if (totalUnique === 0) {
            log('âŒ æ‰¾ä¸åˆ°ä»»ä½• Base64 åœ–ç‰‡ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼ã€‚');
            return;
        }

        // 2. é–‹å§‹å£“ç¸®
        let processed = 0;
        for (const [oldBase64, _] of uniqueImages) {
            processed++;
            log(`âš™ï¸ æ­£åœ¨å£“ç¸®ç¬¬ ${processed}/${totalUnique} å¼µåœ–ç‰‡...`);
            
            try {
                const newBase64 = await compressImage(oldBase64, maxWidth, quality);
                uniqueImages.set(oldBase64, newBase64);
                
                // è¨ˆç®—å–®å¼µå£“ç¸®ç‡
                const oldSize = oldBase64.length;
                const newSize = newBase64.length;
                const ratio = Math.round((1 - newSize/oldSize) * 100);
                log(`   â””â”€ å£“ç¸®ç‡: -${ratio}%`);

            } catch (err) {
                log(`   âš ï¸ å¤±æ•—: ${err.message} (ä¿ç•™åŸåœ–)`);
            }
        }

        // 3. å…¨æ–‡æ›¿æ›
        log(`ğŸ“ æ­£åœ¨é‡çµ„ HTML...`);
        let newHtml = htmlContent;
        for (const [oldBase64, newBase64] of uniqueImages) {
            if (newBase64) {
                // ä½¿ç”¨ split/join é€²è¡Œå…¨åŸŸæ›¿æ›ï¼Œæ¯” replaceAll å®‰å…¨ä¸€é» (é¿å…æ­£å‰‡ç‰¹æ®Šå­—å…ƒ)
                newHtml = newHtml.split(oldBase64).join(newBase64);
            }
        }

        // 4. çµ±è¨ˆèˆ‡ä¸‹è¼‰
        const blob = new Blob([newHtml], { type: 'text/html' });
        const newSize = blob.size;
        const saved = originalSize - newSize;
        
        document.getElementById('stats').innerHTML = `
            åŸå§‹: ${(originalSize/1024/1024).toFixed(2)} MB  âœ  
            ç¾åœ¨: ${(newSize/1024/1024).toFixed(2)} MB 
            (ç˜¦èº« -${((saved/originalSize)*100).toFixed(1)}%)
        `;
        
        log(`âœ… è™•ç†å®Œæˆï¼`);
        
        const url = URL.createObjectURL(blob);
        downloadBtn.onclick = () => {
            const a = document.createElement('a');
            a.href = url;
            a.download = `${originalFileName}_sprite_optimized.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };
        downloadBtn.style.display = 'inline-block';
    }

    function compressImage(base64, maxWidth, quality) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let w = img.width;
                let h = img.height;

                // ä¿æŒæ¯”ä¾‹ç¸®æ”¾
                if (w > maxWidth) {
                    h = Math.round(h * (maxWidth / w));
                    w = maxWidth;
                }

                canvas.width = w;
                canvas.height = h;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, w, h);

                // å˜—è©¦è½‰ç‚º WebP
                resolve(canvas.toDataURL('image/webp', quality));
            };
            img.onerror = () => reject(new Error('åœ–ç‰‡è¼‰å…¥å¤±æ•—'));
            img.src = base64;
        });
    }
</script>

</body>
</html>
