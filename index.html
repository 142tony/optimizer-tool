<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML Base64 ç¸®å°å·¥å…·</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
            min-height: 100vh;
        }

        .container {
            background: var(--surface);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
            text-align: center;
        }

        h1 { margin-top: 0; color: var(--primary); }
        p { color: #64748b; margin-bottom: 2rem; }

        .upload-box {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 40px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .upload-box:hover, .upload-box.dragover {
            border-color: var(--primary);
            background-color: #eff6ff;
        }

        .upload-box input {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        .settings {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            display: none; /* é è¨­éš±è— */
        }

        .btn:hover { background-color: #1d4ed8; }
        
        .btn:disabled { 
            background-color: #94a3b8; 
            cursor: not-allowed; 
        }

        #logArea {
            margin-top: 20px;
            text-align: left;
            background: #1e293b;
            color: #4ade80;
            font-family: monospace;
            padding: 15px;
            border-radius: 8px;
            height: 200px;
            overflow-y: auto;
            font-size: 0.85rem;
            display: none;
        }

        .stats {
            margin-top: 15px;
            font-weight: bold;
            color: var(--primary);
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ–¼ï¸ HTML åœ–ç‰‡æ¥µé™ç˜¦èº«å™¨</h1>
    <p>ä¸Šå‚³ä½ çš„ SingleFile HTMLï¼Œè‡ªå‹•å°‡åœ–ç‰‡ç¸®å°ä¸¦åŠ å…¥ CSS æ‹‰ä¼¸æ•ˆæœã€‚</p>

    <div class="settings">
        <label>
            ç›®æ¨™å¯¬åº¦: <input type="number" id="targetWidth" value="100" style="width: 50px; padding: 5px;"> px
        </label>
        <label>
            WebP å“è³ª: <input type="number" id="quality" value="0.8" step="0.1" max="1" min="0.1" style="width: 50px; padding: 5px;"> (0.1-1.0)
        </label>
    </div>

    <div class="upload-box" id="dropZone">
        <input type="file" id="fileInput" accept=".html,.htm">
        <div id="uploadText">
            ğŸ“ é»æ“Šæˆ–æ‹–æ›³ HTML æª”æ¡ˆè‡³æ­¤<br>
            <span style="font-size: 0.8rem; color: #94a3b8">(é™ SingleFile æ ¼å¼)</span>
        </div>
    </div>

    <div id="logArea"></div>
    <div class="stats" id="statsArea"></div>
    <button id="downloadBtn" class="btn">â¬‡ï¸ ä¸‹è¼‰è™•ç†å¾Œçš„æª”æ¡ˆ</button>
</div>

<script>
    // --- æ ¸å¿ƒé‚è¼¯ ---
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    const logArea = document.getElementById('logArea');
    const downloadBtn = document.getElementById('downloadBtn');
    const uploadText = document.getElementById('uploadText');
    const statsArea = document.getElementById('statsArea');

    let originalFileName = '';

    // æ‹–æ›³æ•ˆæœ
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });
    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
    ['dragenter', 'dragover'].forEach(() => dropZone.classList.add('dragover'));
    ['dragleave', 'drop'].forEach(() => dropZone.classList.remove('dragover'));

    // æª”æ¡ˆç›£è½
    fileInput.addEventListener('change', handleFiles);
    dropZone.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles({ target: { files: files } });
    });

    async function handleFiles(e) {
        const file = e.target.files[0];
        if (!file) return;

        originalFileName = file.name.replace('.html', '').replace('.htm', '');
        
        // UI é‡ç½®
        logArea.style.display = 'block';
        downloadBtn.style.display = 'none';
        statsArea.textContent = '';
        log(`ğŸš€ é–‹å§‹è®€å–: ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`);

        const text = await file.text();
        await processHTML(text, file.size);
    }

    // ğŸ“ è¨˜éŒ„ Log
    function log(msg) {
        logArea.innerHTML += `<div>${msg}</div>`;
        logArea.scrollTop = logArea.scrollHeight;
    }

    /**
     * ä¸»è™•ç†å‡½å¼
     */
    async function processHTML(htmlContent, originalSize) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlContent, 'text/html');
        const images = doc.querySelectorAll('img');
        
        const targetWidth = parseInt(document.getElementById('targetWidth').value) || 60;
        const targetQuality = parseFloat(document.getElementById('quality').value) || 0.2;

        let processedCount = 0;
        const tasks = [];

        // ç¯©é¸å‡º Base64 åœ–ç‰‡
        images.forEach((img, index) => {
            const src = img.getAttribute('src');
            if (src && src.startsWith('data:image')) {
                tasks.push({ img, src, index });
            }
        });

        log(`ğŸ” æ‰¾åˆ° ${tasks.length} å¼µ Base64 åœ–ç‰‡ï¼Œé–‹å§‹å£“ç¸®...`);

        for (let i = 0; i < tasks.length; i++) {
            const task = tasks[i];
            try {
                // 1. å£“ç¸®åœ–ç‰‡
                const newBase64 = await compressImage(task.src, targetWidth, targetQuality);
                
                // 2. æ›¿æ› src
                task.img.setAttribute('src', newBase64);

                // 3. åŠ å…¥å¼·åˆ¶æ‹‰ä¼¸æ¨£å¼ (é—œéµï¼)
                task.img.style.width = '100%';
                task.img.style.height = 'auto';
                task.img.style.objectFit = 'contain';
                task.img.style.display = 'block';

                // 4. æ¸…ç†å±¬æ€§
                task.img.removeAttribute('srcset');
                task.img.removeAttribute('width');
                task.img.removeAttribute('height');

                processedCount++;
                if (processedCount % 10 === 0 || processedCount === tasks.length) {
                    log(`â³ é€²åº¦: ${processedCount} / ${tasks.length}`);
                }
            } catch (err) {
                log(`âš ï¸ åœ–ç‰‡ ${i} è™•ç†å¤±æ•—: ${err.message}`);
            }
        }

        // ç”¢ç”Ÿæ–°æª”æ¡ˆ
        const serializer = new XMLSerializer();
        const newHtml = serializer.serializeToString(doc);
        const blob = new Blob([newHtml], { type: 'text/html' });
        const newSize = blob.size;

        // çµ±è¨ˆ
        const saved = originalSize - newSize;
        const percent = ((saved / originalSize) * 100).toFixed(1);
        
        log(`âœ… å®Œæˆï¼`);
        statsArea.innerHTML = `
            åŸå§‹: ${(originalSize/1024/1024).toFixed(2)} MB â 
            å„ªåŒ–å¾Œ: ${(newSize/1024/1024).toFixed(2)} MB 
            <br>ğŸ”» æ¸›å°‘äº† ${(saved/1024/1024).toFixed(2)} MB (-${percent}%)
        `;

        // æº–å‚™ä¸‹è¼‰æŒ‰éˆ•
        const url = URL.createObjectURL(blob);
        downloadBtn.onclick = () => {
            const a = document.createElement('a');
            a.href = url;
            a.download = `${originalFileName}_optimized.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };
        downloadBtn.style.display = 'inline-block';
    }

    /**
     * ä½¿ç”¨ Canvas å£“ç¸®åœ–ç‰‡
     */
    function compressImage(base64Src, width, quality) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.src = base64Src;
            
            img.onload = () => {
                const canvas = document.createElement('canvas');
                // è¨ˆç®—ç­‰æ¯”ä¾‹é«˜åº¦ (é›–ç„¶æˆ‘å€‘æœƒå¼·åˆ¶ resize åˆ° widthï¼Œä½† canvas æ¯”ä¾‹è¦å°)
                const scaleFactor = width / img.width;
                // å¦‚æœåŸåœ–æ¯”ç›®æ¨™é‚„å°ï¼Œå°±ä¸æ”¾å¤§ï¼Œç›´æ¥å›å‚³åŸåœ– (é¿å…æ¨¡ç³Š)
                if (img.width <= width) {
                    // ä½†æˆ‘å€‘é‚„æ˜¯æƒ³è¦è½‰æˆ WebP ç¯€çœç©ºé–“ï¼Œæ‰€ä»¥ç¹¼çºŒåŸ·è¡Œ
                }

                canvas.width = width;
                canvas.height = img.height * scaleFactor;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                // è½‰å‡º WebP
                // æ³¨æ„ï¼šéƒ¨åˆ†èˆŠç€è¦½å™¨ä¸æ”¯æ´ image/webpï¼Œæœƒè‡ªå‹•é€€å› image/png
                const newDataUrl = canvas.toDataURL('image/webp', quality);
                resolve(newDataUrl);
            };

            img.onerror = (e) => reject(new Error('Image load error'));
        });
    }
</script>

</body>
</html>


